<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>phant0ms的博客</title>
  
  
  <link href="https://phant0ms.github.io/atom.xml" rel="self"/>
  
  <link href="https://phant0ms.github.io/"/>
  <updated>2020-12-13T14:26:08.746Z</updated>
  <id>https://phant0ms.github.io/</id>
  
  <author>
    <name>phant0ms</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>rancher2.x离线安装与harbor私仓配置</title>
    <link href="https://phant0ms.github.io/rancher2-5%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E4%B8%8Eharbor%E7%A7%81%E4%BB%93%E9%85%8D%E7%BD%AE.html"/>
    <id>https://phant0ms.github.io/rancher2-5%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E4%B8%8Eharbor%E7%A7%81%E4%BB%93%E9%85%8D%E7%BD%AE.html</id>
    <published>2020-12-12T03:23:23.000Z</published>
    <updated>2020-12-13T14:26:08.746Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一、rancher简介">一、rancher简介</h2><p>Rancher是一个开源的企业级容器管理平台。通过Rancher，企业再也不必自己使用一系列的开源软件去从头搭建容器服务平台。Rancher提供了在生产环境中使用的管理Docker和Kubernetes的全栈化容器部署与管理平台。官网：<code>https://rancher.com/</code></p><h2 id="二、rancher离线安装">二、rancher离线安装</h2><p>本文基于rancher2.5.1版本进行安装部署。</p><p>如果有网络环境，直接运行下面的命令就可自动安装成功。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker run -d --restart=unless-stopped -p 80:80 -p 443:443 --privileged rancher/rancher</span><br></pre></td></tr></table></figure><p>大多时候，我们内网的环境可能是没有网络环境，这个时候就需要离线安装，rancher提供离线安装方式，首先在外网下载好需要用的脚本与docker镜像：<br>下载地址：<a href="https://github.com/rancher/rancher/releases%EF%BC%8C">https://github.com/rancher/rancher/releases，</a> 推荐下载Stable版本，bug相对较少,不要下载标记为 rc 或 Pre-release 的版本，因为它们在生产环境下是不稳定的。下载好<code>rancher-save-images.sh</code>、<code>rancher-load-images.sh</code> 、<code>rancher-images.txt</code>、三个脚本，脚本执行 <code>./rancher-save-images.sh --image-list ./rancher-images.txt</code>。这个脚本会自动下载rancher需要用的docker镜像。下载完成后将生成的ancher-images.tar.gz与上面的三个脚本一同复制到内网放在同一目录下。</p><blockquote><p>注：里面存在同一镜像多个版本，可保留一个版本即可</p></blockquote><p>去除重复的镜像源：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sort -u rancher-images.txt -o rancher-images.txt</span><br></pre></td></tr></table></figure><table><thead><tr><th>Release</th><th>文件描述</th></tr></thead><tbody><tr><td>rancher-images.txt</td><td>此文件包含安装 Rancher、创建集群和运行Rancher 工具所需的镜像列表。</td></tr><tr><td><a href="http://rancher-save-images.sh">rancher-save-images.sh</a></td><td>这个脚本会从 DockerHub 中拉取在文件rancher-images.txt中描述的所有镜像，并将它们保存为文件rancher-images.tar.gz。</td></tr><tr><td><a href="http://rancher-load-images.sh">rancher-load-images.sh</a></td><td>这个脚本会载入文件rancher-images.tar.gz中的镜像，并将它们推送到您自己的私有镜像库。</td></tr></tbody></table><p>将打包好的镜像导入到docker中，执行：<br><code>docker load -i rancher.tar</code>。 稍等片刻便会导入成功。</p><p><code>rancher-load-images.sh</code>用于将打包好的镜像导入到docker。导入成功后启动rancher，执行：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker run -d --restart=unless-stopped -p 80:80 -p 443:443 --privileged rancher/rancher</span><br></pre></td></tr></table></figure><p>稍等片刻访问 <code>https://ipaddress</code>就能进入rancher</p><h2 id="三、使用Harbor配置Docker镜像仓库">三、使用Harbor配置Docker镜像仓库</h2><p>Harbor是企业级镜像仓库，官方地址：<a href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a><br>下载离线安装包：<code>harbor-offline-installer-v2.0.5.tgz</code> 并复制到内网。harbor需要用到证书，先生成自己的证书，证书的CN需要与域名或者ip完全一致：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p certs</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> openssl req \</span></span><br><span class="line">  -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key \</span><br><span class="line">  -x509 -days 365 -out certs/domain.crt</span><br></pre></td></tr></table></figure><p>编辑配置文件harbor.yml, 修改 hostname 域名、https 证书等配置信息,其它的可按需修改：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Configuration file of Harbor</span></span><br><span class="line"><span class="comment"># The IP address or hostname to access admin UI and registry service.</span></span><br><span class="line"><span class="comment"># DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.</span></span><br><span class="line"><span class="attr">hostname:</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span> <span class="comment"># hostname不能是localhost或127.0.0.1</span></span><br><span class="line"><span class="comment"># http related config</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="comment"># port for http, default is 80. If https enabled, this port will redirect to https port</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="comment"># https related config</span></span><br><span class="line"><span class="attr">https:</span></span><br><span class="line">  <span class="comment"># https port for harbor, default is 443</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="comment"># The path of cert and key files for nginx</span></span><br><span class="line">  <span class="attr">certificate:</span> <span class="string">/certs/domain.crt</span> <span class="comment"># 证书路径</span></span><br><span class="line">  <span class="attr">private_key:</span> <span class="string">/certs/domain.key</span>  <span class="comment">#私钥路径</span></span><br></pre></td></tr></table></figure><p>接着执行如下命令进行安装：</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./install.sh --with-clair</span></span><br></pre></td></tr></table></figure><p>–with-clair 指定安装 Clair 服务，一个用户镜像漏洞静态分析的工具。如果不需要，可以省略该选项。</p><p>安装成功后, 可通过https://ipadress来访问web UI .默认的账号密码是<code>admin/Harbor12345</code></p><h2 id="四、推送镜像到私仓">四、推送镜像到私仓</h2><p>推送之前需要先登录，使用<code>docker login</code>命令，如下。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker login 10.10.10.10</span></span><br><span class="line">Username: admin</span><br><span class="line">Password: Harbor12345</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure><p>因为我们用的自签证书，docker可能会提示证书不受信，需要配置docker信任我们的自签证书</p><p>1、复制证书到：<code>etc/docker/certs.d/10.10.10.10/ca.crt</code> , 其中文件夹<br><code>10.10.10.10</code>需要根据实际ip地址或者域名填写。</p><blockquote><p>如果是windows服务器上需要安装到受信任的根证书目录</p></blockquote><blockquote><p>其它服务器可参考docker官网文档：<a href="https://docs.docker.com/registry/insecure/">https://docs.docker.com/registry/insecure/</a></p></blockquote><p>如果提示：</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">docker: Error response from daemon: Get https://x.x.x.x/v2/: x509: cannot validate certificate for x.x.x.x because it doesn&#x27;t contain any IP SANs</span><br></pre></td></tr></table></figure><p>简单的方案是加入<code>--insecure-registry</code>参数:</p><p><code>vim /usr/lib/systemd/system/docker.service</code></p><p>在 <code>ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</code> 一行后面添加 <code>--insecure-registry==你的ip或者域名</code></p><p>然后重启docker</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl daemon-reload</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl restart docker</span></span><br></pre></td></tr></table></figure><p>使用<code>rancher-load-images.sh</code>将下载好的镜像导入到私仓</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./rancher-load-images.sh --image-list ./rancher-images.txt --registry &lt;REGISTRY.YOURDOMAIN.COM:PORT&gt;`</span><br></pre></td></tr></table></figure><p><code>&lt;REGISTRY.YOURDOMAIN.COM:PORT&gt;</code>是harbor的地址，443可以不用填写</p><h2 id="五、rancher集群配置">五、rancher集群配置</h2><p>rancher 默认创建了local集群，里面有两个项目，一个system，一个default。关于命令空间与项目，可访问https://docs.rancher.cn/docs/rancher2/cluster-admin/projects-and-namespaces/_index/ 官网查看详细解释。官方不推荐去操作local集群里面的服务。所以我们新建一个集群。</p><p>新建一个集群，指定私仓为我们刚搭建的ip。<br><img src="./rancher2-5%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E4%B8%8Eharbor%E7%A7%81%E4%BB%93%E9%85%8D%E7%BD%AE/rancher-cluster-hoem.png" alt="rancher-home"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;一、rancher简介&quot;&gt;一、rancher简介&lt;/h2&gt;
&lt;p&gt;Rancher是一个开源的企业级容器管理平台。通过Rancher，企业再也不必自己使用一系列的开源软件去从头搭建容器服务平台。Rancher提供了在生产环境中使用的管理Docker和Kubernet</summary>
      
    
    
    
    
  </entry>
  
</feed>
